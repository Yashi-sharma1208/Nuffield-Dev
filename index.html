<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8" />
    <title>Nuffield Health Support</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            background: #f3f8f6;
        }

        header {
            background: #2a6f55;
            padding: 20px;
            text-align: center;
            color: white;
            font-size: 22px;
            font-weight: bold;
        }

        .hero {
            text-align: center;
            padding: 40px;
        }

        .hero img {
            width: 120px;
            margin-bottom: 20px;
        }

        .info-box {
            max-width: 700px;
            background: white;
            padding: 20px;
            margin: 0 auto;
            border-radius: 10px;
            text-align: center;
            font-size: 18px;
            color: #444;
            box-shadow: 0px 2px 8px rgba(0, 0, 0, 0.1);
        }
    </style>
</head>

<body>

    <header>
        Nuffield Health â€¢ Customer Support
    </header>

    <div class="hero">
        <img src="https://cdn-icons-png.flaticon.com/512/2966/2966327.png" alt="Hospital Icon">
        <div class="info-box">
            Welcome to Nuffield Health Support.
            <br /><br />
            You can use the chat button (bottom-right) to ask questions or book an appointment.
            <br /><br />
            Our support bot will assist you shortly.
        </div>
    </div>

    <!-- Embedded Messaging Code -->
    <script type='text/javascript'>
        let firstName = "";
        let transcriptId = "";
        let handoffTriggered = false;
        let cxOneLoaded = false;

        function loadCXoneScript() {
            (function (n, u) {
                window.CXoneDfo = n;
                window[n] = window[n] || function () {
                    (window[n].q = window[n].q || []).push(arguments)
                };
                window[n].u = u;
                const script = document.createElement("script");
                script.type = "module";
                script.src = u + "?" + Math.round(Date.now() / 3600000);
                script.onload = () => {
                    cxOneLoaded = true;
                    console.log("âœ” CXone script successfully loaded.");
                };
                document.head.appendChild(script);
            })('cxone', 'https://web-modules-de-uk1.niceincontact.com/loader/1/loader.js');
        }

        function startCXoneSession() {
            if (!cxOneLoaded) {
                console.warn("â³ Waiting for CXone to load...");
                setTimeout(startCXoneSession, 500);
                return;
            }

            console.log("ðŸ”¥ Starting NICE CXone Handoff...");

            cxone('init', '1152');
            cxone('chat', 'init', 1152, 'chat_77cdeb00-0c80-41cb-874b-0e7df1067e0c');

            cxone('chat', 'setCustomerName', firstName || "Guest");
            cxone('chat', 'setCustomField', 'nuffskill', '{{Nuffield_Department}}');
            cxone('chat', 'setCustomField', 'sfticketid', transcriptId);

            cxone('chat', 'sendFirstMessageAutomatically', transcriptId);
            cxone('chat', 'hideSystemMessages');
            cxone('chat', 'enableChatAlwaysOnline');
            cxone('chat', 'hidePreSurvey');
            cxone('chat', 'openChatWindow');
            cxone('chat', 'autoStartSession');
        }

        function initEmbeddedMessaging() {
            try {
                embeddedservice_bootstrap.settings.language = 'en_US';

                window.addEventListener("onEmbeddedMessagingPreChatSubmitted", ({ detail }) => {
                    firstName = detail.prechatSubmitFields._firstName || "";
                    console.log("User Name:", firstName);
                });

                window.addEventListener("onEmbeddedMessageSent", (event) => {
                    const payload = JSON.parse(event.detail.conversationEntry.entryPayload);
                    const messageText = payload.abstractMessage?.staticContent?.text;
                    console.log("Extracted text:", messageText);

                    if (messageText?.includes("welcome to Nuffield Customer Support")) {
                        const match = messageText.match(/Your transcript ID is\s*([A-Za-z0-9-]+)/i);
                        if (match) transcriptId = match[1].trim();
                        console.log("Transcript ID:", transcriptId);
                    }

                    // *** DO NOT MODIFY CONDITION BELOW ***
                    if (messageText == 'Transferring chat to agent.' && !handoffTriggered) {
                        handoffTriggered = true;
                        loadCXoneScript();
                        startCXoneSession();
                    }
                });

                embeddedservice_bootstrap.init(
                    '00DS900000DRZFB',
                    'Agentforce_Customer_Support_Dev',
                    'https://nuffieldhealth-crm--mintdev.sandbox.my.site.com/ESWAgentforceCustomerSu1764669389369',
                    {
                        scrt2URL: 'https://nuffieldhealth-crm--mintdev.sandbox.my.salesforce-scrt.com'
                    }
                );

            } catch (err) {
                console.error('Error loading Embedded Messaging:', err);
            }
        }
    </script>

    <script type='text/javascript'
        src='https://nuffieldhealth-crm--mintdev.sandbox.my.site.com/ESWAgentforceCustomerSu1764669389369/assets/js/bootstrap.min.js'
        onload='initEmbeddedMessaging()'></script>

</body>
</html>
